rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNZIONI HELPER ---

    // Verifica token admin (Sicuro: controlla il claim nel token JWT, non nel documento)
    function isAdmin() {
      return request.auth != null && 'admin' in request.auth.token && request.auth.token.admin == true;
    }

    // Verifica ownership di base
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Verifica che l'utente non stia modificando campi sensibili/immutabili
    function notUpdating(protectedFields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasAny(protectedFields) == false;
    }

    // --- REGOLE COLLEZIONI ---

    // 1. Users Collection
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();

      // CREATE: L'utente può creare il profilo ma NON può settare ruoli o flag admin
      allow create: if isOwner(userId) &&
        !('admin' in request.resource.data) &&
        !('role' in request.resource.data) &&
        !('isSuperUser' in request.resource.data);

      // UPDATE: L'utente può aggiornare solo campi specifici
      allow update: if isOwner(userId) &&
        notUpdating(['admin', 'role', 'permissions', 'createdAt', 'banned']);

      // DELETE: Solo l'utente stesso o un admin
      allow delete: if isOwner(userId) || isAdmin();
    }

    // 2. Elite Four Teams (User-scoped)
    match /users/{userId}/elite_four_teams/{teamId} {
      allow read: if isOwner(userId) || isAdmin();
      
      allow create: if isOwner(userId) && 
        request.resource.data.status in ['draft', 'pending'] &&
        request.resource.data.isPublic == false;
      
      allow update: if isAdmin() || (
        isOwner(userId) && 
        resource.data.status != 'approved' &&
        request.resource.data.status in ['draft', 'pending'] &&
        request.resource.data.isPublic == false &&
        notUpdating(['createdAt', 'ownerId', 'adminNotes', 'approvedBy'])
      );
      
      allow delete: if isOwner(userId) || isAdmin();
    }

    // 3. Collection Group Query (Public Feed)
    match /{path=**}/elite_four_teams/{teamId} {
      allow read: if resource.data.status == 'approved' || isAdmin();
    }

    // --- STATIC DATA COLLECTIONS (Game Data) ---
    
    match /pokedex/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /raids/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /super_trainers/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /pickup/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /boss_fights/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}