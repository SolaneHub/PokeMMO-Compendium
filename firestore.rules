rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is admin
    // Checks if the 'admin' key exists in the token AND is true
    function isAdmin() {
      return request.auth != null && 'admin' in request.auth.token && request.auth.token.admin == true;
    }

    // Helper to check if user is the owner
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Users collection: only the authenticated user can read/write their own data
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Elite Four Teams subcollection (User-scoped access)
    match /users/{userId}/elite_four_teams/{teamId} {
      allow read: if isOwner(userId) || isAdmin();
      
      allow create: if isOwner(userId) && 
        request.resource.data.status in ['draft', 'pending'] &&
        request.resource.data.isPublic == false;
      
      allow update: if isAdmin() || (
        isOwner(userId) && 
        request.resource.data.status in ['draft', 'pending'] &&
        (resource.data.status == 'draft' || request.resource.data.status != 'draft') &&
        request.resource.data.isPublic == false
      );
      
      allow delete: if isOwner(userId) || isAdmin();
    }

    // Collection Group query for public/admin reading of teams
    match /{path=**}/elite_four_teams/{teamId} {
      allow read: if resource.data.status == 'approved' || isAdmin();
    }

    // Pokedex collection: public read, admin write
    match /pokedex/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
