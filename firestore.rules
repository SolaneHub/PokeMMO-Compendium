rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection: only the authenticated user can read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow users to create their own teams, with a rate limit of 1 per second
    match /users/{userId}/elite_four_teams/{teamId} {
      allow create: if request.auth != null &&
                      request.auth.uid == userId &&
                      request.time < resource.data.createdAt + duration.value(1, 's'); // Max 1 per secondo
    }

    // Elite Four Teams subcollection: users can read/write their own teams,
    // admins can read/write all teams, public can read approved and public teams
    match /users/{userId}/elite_four_teams/{teamId} {
      allow read: if
        // Approved public teams are visible to everyone
        (resource.data.status == 'approved' && resource.data.isPublic == true) ||
        // Otherwise, if you are the owner or an admin
        (request.auth != null && (
          request.auth.uid == userId ||
          request.auth.token.admin == true
        ));
      allow write: if request.auth != null && (
        request.auth.uid == userId ||
        request.auth.token.admin == true
      );
    }
  }
}
